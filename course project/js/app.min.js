jQuery(function ($) {

    /* *****************
     * Настройки по умолчанию
     * *****************/

    // Средство выбора цвета по умолчанию
    $('#card_label_color,#board_color,#board_new_color').spectrum({
        preferredFormat: "hex",
        showInput: true,
        showInitial: true,
        showPaletteOnly: true, // Создавайте только палитры внешнего вида
        palette: [ // Укажите цвет, который будет использоваться в палитре

            ["#ffffff", "#cccccc", "#999999", "#666666", "#333333", "#000000"],
            ["#f44336", "#ff9800", "#ffeb3b", "#8bc34a", "#4caf50", "#03a9f4", "#2196f3"]
        ]
    });

    // Модальный(Remodal）Инициализация
    // JS Для открытого процесса - создайте экземпляр и откройте или закройте его
    var timeoutRemodal = $('[data-remodal-id=modal]').remodal();
    var searchResultRemodal = $("[data-remodal-id=serach_result_modal]").remodal();

    /**
     * Выведите режим тайм-аута и закройте его
     * @returns {undefined}
     */
    function msgTimeout() {
        timeoutRemodal.open();
        // После открытия закройте через 3 секунды
        setTimeout(function () {
            timeoutRemodal.close();
        }, 3000);
    }

    // Сортировка панелей
    $(".sortable").sortable();

    // Обновите порядок сортировки, когда панель завершит переупорядочивание
    $(document).on('sortstop','.sortable',function(){
        var sortArray = [];
        $(".pannel").each(function(index) {
            var panel_id = $(this).find("h2").attr("data-id");
            if(panel_id !==''){
                sortArray.push(panel_id);
            }
        });
        var sortText = JSON.stringify(sortArray);
        exePost("panels", "sort", "", sortText, "").done(function() {
        }).fail(function() {
            msgTimeout();
        });
    });

    // Сортировка карточек
    // connectWith Сортируют друг друга по элементам, указанным в
    $(".panel-body").sortable({
        connectWith: '.panel-body'
    });

   // Обновите порядок, когда карточки будут отсортированы
    $(document).on('sortstop','.panel-body',function(){
        // Агрегированный массив по панелям
        // id = panels_id, title = card_id Отправить в массиве
        $(".pannel").each(function(index) {
            // Получить идентификатор панели
            var panel_id = $(this).find("h2").attr("data-id");
            // Исключение пустых идентификаторов панелей
            if(panel_id !==''){
                // Получите идентификатор карты
                var sortArray = [];
                $("#panel_area .panel h2[data-id='"+panel_id+"']").parent().parent().children('.panel-body').find('.card').each(function(index) {
                    var card_id = $(this).attr("cardid");
                    if(card_id !==''){
                        sortArray.push(card_id);
                    }
                });
                var sortText = JSON.stringify(sortArray);
                exePost("cards", "sort", panel_id, sortText, "").done(function() {
                }).fail(function() {
                    msgTimeout();
                });
            }
        });
    });


    /* *****************
     * Начальный дисплей
     * *****************/
    // Панель извлекает наименьший идентификатор с флагом удаления 0 и удаляет заголовок и цвет фона
    exePost("boards", "first", "", "", "").done(function(data) {
        if (data) {
            var detail = $.parseJSON(data);
            $('#board_title h1').html(detail['title']);
            $('#board_title').attr('data-id', detail['id']);
            $('body').css('background-color', detail['board_color'])
            $("input#board_title_text").val(detail['title']);
            $("input#board_color").val(detail['board_color']);
            $("input#board_color").spectrum({
                showSelectionPalette: true,
                preferredFormat: "hex",
                showInput: true,
                showInitial: true,
                showPaletteOnly: true, //Создавайте только палитры внешнего вида
                palette: [// Укажите цвет, который будет использоваться в палитре
                    ["#ffffff", "#cccccc", "#999999", "#666666", "#333333", "#000000"],
                    ["#f44336", "#ff9800", "#ffeb3b", "#8bc34a", "#4caf50", "#03a9f4", "#2196f3"]
                ]
            });
            // Панели отображения, связанные с платой
            getPanels(detail['id']);
        }
    }).fail(function(data) {
        msgTimeout();
    });

    // Получите список досок
    getBoardList();

    // Щелкните по списку плат, чтобы переключить доску
    $(document).on('click', '#board_all_list li', function() {
        var boards_id = $(this).attr('data-board');
        getBoard(boards_id);
    });

    // Выйти из системы
    $(document).on('click', '#logout', function() {
        window.location.replace("logout.php");
    });


    //////////////////////////////////////////////////
    // Панель
    //////////////////////////////////////////////////
    // Увеличьте панель
    $("#panel_add").on("click", function (e) {
        // Добавьте пустую панель
        $("#panel_area").append($("#hidden .panel").html());

        // Повторно установите карту на панели так, чтобы ее можно было перетаскивать
        $("#panel_area .panel-body").sortable({
            connectWith: '.panel-body'
        });
        return false;
    });

    // Нажмите на заголовок панели, чтобы открыть режим редактирования
    $(document).on("click", ".panel h2", function () {
        var id = $(this).attr("data-id");
        $("#panel-modal").attr("data-id", id);
        // Когда новый
        if(id ==='new'){
            // Скрыть кнопку удаления
            $('#panel-modal button#delete-btn').hide();
            $('#panel-modal #panel_title_text').val('');
        }else{
            $('#panel-modal button#delete-btn').show();
            $('#panel-modal #panel_title_text').val($(this).html());
        }

        $('#panel-modal').modal('show');
    });

    // Нажмите кнопку Сохранить в режиме панели, чтобы выполнить процесс сохранения
    $(document).on("click", "#panel-modal .modal-dialog .modal-footer button#save-panel-btn", function () {
        var panel_title_text = $('#panel_title_text').val();
        var panel_id = $('#panel-modal').attr('data-id');
        var board_id = $('#board_title').attr("data-id");
        // IDЕсли вы не можете получить новую минуту
        if ( (typeof panel_id === "undefined") || ( panel_id === "")) {
            panel_id = 'new';
        }
        exePost("panels", "save", panel_id, panel_title_text, board_id).done(function(data) {
            var detail = $.parseJSON(data);
            // Обновите заголовок с помощью сохраненных данных
            // new Время пришло、data-id = new к цели、Помимо этого, существующийIDДля поиска в
            if(panel_id === 'new'){
                $("#panel_area .panel").find("h2[data-id='new']").eq(0).html(detail['title']);
                $("#panel_area .panel").find("h2[data-id='new']").eq(0).attr("data-id", detail['id']);
            }else{
                $("#panel_area .panel h2[data-id='"+panel_id+"']").attr("data-id", detail['id']);
                $("#panel_area .panel h2[data-id='"+panel_id+"']").html(detail['title']);
            }
            $('#panel-modal').modal('hide'); // Близкий модальный
        }).fail(function(data) {
            msgTimeout();
        });
    });

    // Нажмите кнопку Удалить на модальной панели для подтверждения
    $(document).on("click", "#panel-modal .modal-dialog .modal-footer button#delete-btn", function () {
         if (window.confirm(DELETE_PANEL_MSG)) {
            var panel_id = $('#panel-modal').attr('data-id');
            exePost("panels", "del", panel_id, "", "", "", "").done(function () {
                $("#panel_area .panel h2[data-id='" + panel_id + "']").parent().parent().remove();
                $('#panel-modal').modal('hide'); // Близкий модальный
            }).fail(function () {
                msgTimeout();
            });
        }
    });



    // Когда вы нажимаете на заголовок do, открывается модальное окно обновления.
    $(document).on("click", "#board_title h1", function () {
        $('#board-modal').modal('show');
    });

    // После нажатия кнопки Add Board откройте модальное окно редактирования.
    $(document).on("click", "#board_add", function () {
        $("#board_new_title_text").val('');
        $("#board_new_color").val('#000');
        $('#board-add-modal').modal('show');
    });

    // Сохраните процесс после нажатия кнопки Сохранить на модале для платы и обновления.
    $(document).on("click", "#board-modal #save-btn", function () {
        var board_title_text = $('#board_title_text').val();
        var board_color = $('#board_color').val();
        var id = $('#board_title').attr("data-id");
        exePost("boards", "save", id, board_title_text, board_color).done(function(data) {
            var detail = $.parseJSON(data);
            $('#board_title h1').html(detail['title']);
            $('body').css('background-color', detail['board_color']);
            $("input#board_title_text").val(detail['title']);
            $('#board_title').attr("data-id", detail['id']);
            getBoardList(); // Получение списка досок.
            $('#board-modal').modal('hide'); // Закрыть модальное окно
        }).fail(function(data) {
            msgTimeout();
        });
    });

    // Сохраните процесс после нажатия кнопки Save в модале Board and Registration.
    $(document).on("click", "#board-add-modal #save-btn", function () {
        var board_title_text = $('#board_new_title_text').val();
        var board_color = $('#board_new_color').val();
        exePost("boards", "save", "new", board_title_text, board_color).done(function(data) {
            var detail = $.parseJSON(data);
            $('#board_title h1').html(detail['title']);
            $('body').css('background-color', detail['board_color']);
            $("input#board_title_text").val(detail['title']);
            $('#board_title').attr("data-id", detail['id']);
            $("#panel_area").html(''); // Очистите панель, так как это новая плата.
            getBoardList(); // Получение списка досок.
            $('#board-add-modal').modal('hide'); // Закрыть модальное окно
        }).fail(function(data) {
            msgTimeout();
        });
    });


    // Подтверждение при нажатии кнопки удаления в модальном окне форума.
    $(document).on("click", "#board-modal #delete-btn", function () {
        if (window.confirm(DELETE_BOARD_MSG)) {
            var id = $('#board_title').attr("data-id");
            exePost("boards", "del", id, "", "", "", "").done(function () {
                // Плата была удалена, и первоначальное отображение должно быть сделано заново.
                exePost("boards", "first", "", "", "").done(function (data) {
                    var detail = $.parseJSON(data);
                    $('#board_title h1').html(detail['title']);
                    $('#board_title').attr('data-id', detail['id']);
                    $('body').css('background-color', detail['board_color'])
                    $("input#board_title_text").val(detail['title']);
                    $("input#board_color").val(detail['board_color']);

                    // Отображение панелей, связанных с платой.
                    getPanels(detail['id']);
                }).fail(function (data) {
                    msgTimeout();
                });
                getBoardList(); // Получение списка досок.
                $('#board-modal').modal('hide'); // Закрыть модальное окно
            }).fail(function () {
                msgTimeout();
            });
        }
    });

    //////////////////////////////////////////////////
    // карточка
    //////////////////////////////////////////////////
    // Нажмите на карточку, чтобы открыть модальное окно редактирования.
    $(document).on('click', '.panel-body .card', function() {

        // При отображении изображений извлекаются только текстовые данные.
        var cardTitle = $(this).html();
        if (cardTitle.substr(0, 4) == '<img') {
            cardTitle = $("img", this).attr("src");
        }
        $("#card_title_text").val(cardTitle);
        $('#card-edit').attr('data-id', $(this).attr("cardId"));
        $('#card-edit').attr('card_panel_id', $(this).parent().parent().find('.panel-heading h2').attr("data-id"));
        $("#card_label_color").val($(this).attr("label_color"));
        // Обновление идентификатора модального окна дублирования/перемещения
        $("#card-move-modal").attr('data-id', $(this).attr("cardId"));

        if ($(this).attr("cardId") === 'new') {
            //На новых карточках отсутствуют кнопки удаления и перемещения/дублирования.
            $("#move-btn").hide();
            $("#delete-btn").hide();

            $("#card_title_text").val('');
            $("#contents").val('');
            $("#contents_view").html('');
            $("#card_label_color").val("#cccccc");
            $("#card_label_color").spectrum({
                showSelectionPalette: true,
                preferredFormat: "hex",
                showInput: true,
                showInitial: true,
                showPaletteOnly: true, // Сделайте внешний вид только для палитры.
                palette: [// Укажите цвета, которые будут использоваться в палитре.
                    ["#ffffff", "#cccccc", "#999999", "#666666", "#333333", "#000000"],
                    ["#f44336", "#ff9800", "#ffeb3b", "#8bc34a", "#4caf50", "#03a9f4", "#2196f3"]
                ]
            });
        } else {
            $("#move-btn").show();
            $("#delete-btn").show();
            // Извлечение и отражение контента
            exePost("cards", "find", $(this).attr("cardId"), "", "", "", "").done(function (data) {
                if (data) {
                    var detail = $.parseJSON(data);
                    $("#contents").val(detail['contents']);
                    $("#contents_view").html(nl2br(detail['contents'])).linkify({
                        target: "_blank" // Замените URL-адреса в карточках ссылками.
                    });

                    $("#card_label_color").val(detail['label_color']);
                    $("#card_label_color").spectrum({
                        showSelectionPalette: true,
                        preferredFormat: "hex",
                        showInput: true,
                        showInitial: true,
                        showPaletteOnly: true, // Сделайте внешний вид только для палитры.
                        palette: [// Укажите цвета, которые будут использоваться в палитре.
                            ["#ffffff", "#cccccc", "#999999", "#666666", "#333333", "#000000"],
                            ["#f44336", "#ff9800", "#ffeb3b", "#8bc34a", "#4caf50", "#03a9f4", "#2196f3"]
                        ]
                    });

                }
            }).fail(function (data) {
                msgTimeout();
            });

            // Первоначальный вид, отключение режима редактирования
            $("#contents").css('display', 'none');
            $("#contents_view").css('display', 'block');
        }
        $('#card-edit').modal('show');
    });

    // После нажатия кнопки "Редактировать" на карточке переключите вид содержимого.
    $(document).on('click', '#contents_toggle', function () {
        $("#contents_view").toggle();
        $("#contents").toggle();
        if($("#contents_toggle").html() === CARD_EDIT){
            $("#contents_toggle").html(CARD_VIEW);
        }else{
            $("#contents_toggle").html(CARD_EDIT);
        }
    });


    // Другие карты.
    $(document).on('click', '.pannel .panel-footer .card_add', function () {
        $(this).parent().parent().children('.panel .panel-body').append($('<div class="card panel panel-default" label_color="" cardid="new">New</div>'));
    });


    // Сохраните процесс после нажатия кнопки Сохранить на модале карты.
    $(document).on("click", "#card-edit .modal-dialog .modal-footer button#save-btn", function () {
        var card_title_text = $('#card_title_text').val();
        var card_label_color = $("#card_label_color").val();
        var contents = $("#contents").val();
        var card_id = $('#card-edit').attr('data-id');
        var board_id = $('#board_title').attr("data-id");
        var panel_id = $('#card-edit').attr('card_panel_id');

        // IDне может быть получена, новая минута
        if ( (typeof card_id === "undefined") || ( card_id === "") ) {
            card_id = 'new';
        }
        exePost("cards", "save", card_id, card_title_text, panel_id, card_label_color, contents).done(function(data) {
            var detail = $.parseJSON(data);
            var label_color = detail["label_color"];
            if(label_color == null){
                label_color = "";
            }
            // Если в одной и той же панели имеется более одного card_id = new, обновляется первый элемент.
            // new Если нет id, то должен быть id, поэтому найдите и обновите элемент на основе id
            // Обновление заголовков и этикеток с сохраненными данными.
            if( $("#panel_area .panel h2[data-id='"+panel_id+"']").parent().parent().find(".panel-body .card[cardId='new']").length > 0) {
                $("#panel_area .panel h2[data-id='"+panel_id+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").html(detail["title"]);
                $("#panel_area .panel h2[data-id='"+panel_id+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").attr("style", "border-top: 12px solid "+label_color);
                // Наконец, измените ID на ID, полученный из new.
                $("#panel_area .panel h2[data-id='"+panel_id+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").attr("cardID", detail["id"]);
            }else{
                $(".card[cardId='"+detail["id"]+"']").html(detail["title"]);
                $(".card[cardId='"+detail["id"]+"']").attr("style", "border-top: 12px solid "+label_color);
            }

            // Сброс внутри модала, а затем закройте модал.
            $('#card_title_text').val('');
            $("#card_label_color").val('');
            $("#contents").val('');
            $('#card-edit').modal('hide');
        }).fail(function(data) {
            msgTimeout();
        });
    });

    // Подтверждение удаления отображается при нажатии кнопки Удалить в модале карты.
    $(document).on("click", "#card-edit .modal-dialog .modal-footer button#delete-btn", function () {
        if (window.confirm(DELETE_CARD_MSG)) {
            var card_id = $('#card-edit').attr('data-id');
            var panel_id = $('#card-edit').attr('card_panel_id');
            exePost("cards", "del", card_id, "", "", "", "").done(function () {
                $("#panel_area .panel h2[data-id='" + panel_id + "']").parent().parent().find(".panel-body .card[cardId='" + card_id + "']").remove();
                $('#card-edit').modal('hide');
            }).fail(function () {
                msgTimeout();
            });
        }
    });

    //////////////////////////////////////////////////
    // Перемещение карточек
    //////////////////////////////////////////////////
    // Нажатие кнопки перемещения/дублирования на модале карточки открывает специальный модал.
    $(document).on("click", "#card-edit .modal-dialog .modal-footer button#move-btn", function () {
        // Открытая модальная.
        $('#card-move-modal').modal('show');
        // Получение списков досок и отражение их в модальном окне
        $("#panel_select").html('');
        exePost("boards", "list", "", "", "").done(function(data) {
            var obj = $.parseJSON(data);
            var lists = "<option value=''>-</option>";
            $.each(obj, function(index, value) {
                lists += "<option value='" + value["id"]+"'>" + value["title"] + "</option>";
            });
            $("#board_select").html('');
            $("#board_select").append(lists);
            // Предотвращение многократной регистрации событий
            $("#card-move-modal .modal-dialog .modal-footer button#save-panel-btn").off("click");
            $("#card-move-modal .modal-dialog .modal-footer button#save-panel-btn").on("click", saveMovingCard);
        }).fail(function() {
            msgTimeout();
        });
    });

    // После выбора списка плат обновите список панелей.
    $(document).on("change", "#board_select", function () {
        exePost("panels", "list", $(this).val(), "", "").done(function (data) {
            if (data !== false) {
                var obj = $.parseJSON(data);
                var lists = "";
                $.each(obj, function (index, value) {
                    lists += "<option value='" + value["id"] + "'>" + value["title"] + "</option>";
                });
            }
            $("#panel_select").html('');
            $("#panel_select").append(lists);
        }).fail(function (data) {
            msgTimeout();
        });
    });
    //  Перевод карты на данный момент */
    //////////////////////////////////////////////////
    // Поиск карты.
    //////////////////////////////////////////////////
    // Выполните поиск, нажав кнопку поиска, и отобразите результаты в измененном виде.
    $(document).on("click", "#searchExe", function () {
        var search_word = trim($('.searchbox').val());
        // Если ключевое слово пустое, не отправляйте.
        if (search_word != '') {
            exePost("cards", "search", search_word).done(function (data) {
                if (data != 'false') {
                    var obj = $.parseJSON(data);
                    var lists = "";
                    $.each(obj, function (index, value) {
                        lists += "<p><a card_id='" + value["id"] + "' panels_id='" + value["panels_id"] + "' boards_id='" + value["boards_id"] + "'>" + value["title"] + "</a></p>";
                    });
                    $("[data-remodal-id='serach_result_modal'] #searchResult").html(lists);
                    searchResultRemodal.open();
                } else {
                    $("[data-remodal-id='serach_result_modal'] #searchResult").html("<p>Не найдено</p>");
                    searchResultRemodal.open();
                }
            }).fail(function (data) {
                msgTimeout();
            });
        } else {
            $(".searchbox").attr("placeholder", ENTER_KEYWORD);
            setTimeout(function(){
                $(".searchbox").attr("placeholder", "Search for...");
            },2000);
        }

    });
    // Поиск карты на данный момент */

    // После нажатия на результат поиска перейдите на соответствующую доску объявлений, чтобы показать карточку.
    $(document).on("click", "#searchResult a", function () {
        var card_id = $(this).attr("card_id");
        var panels_id = $(this).attr("panels_id");
        var boards_id = $(this).attr("boards_id");
        getBoard(boards_id);
        searchResultRemodal.close();
        setTimeout(function(){
            $("#panel_area .card[cardid="+card_id+"]").trigger("click");
        },3000);
    });

}); // jQuery(function($) End

function saveMovingCard() {
    var boards_id = $("#board_select").val();
    var panels_id = $("#panel_select").val();
    var id = $("#card-move-modal").attr('data-id');
    var mode = $("input[name='q']:radio:checked").val();
    exePost("cards", mode, id, panels_id, "", "", "").done(function () {
        // Закрытие открытого модала
        $('#card-move-modal').modal('hide');
        $('#card-edit').modal('hide');
        $("#board_all_list li[data-board=" + boards_id + "]").trigger("click");
    }).fail(function () {
        msgTimeout();
    });
}



// Получение информации о совете директоров и отражение ее на экране.
function getBoard(id){
    exePost("boards", "find", id, "", "").done(function(data) {
        // Отражает содержание доски.
        var detail = $.parseJSON(data);
        $('#board_title h1').html(detail['title']);
        $('#board_title').attr('data-id', detail['id']);
        $('body').css('background-color', detail['board_color'])
        $("input#board_title_text").val(detail['title']);
        $("input#board_color").val(detail['board_color']);
        $("input#board_color").spectrum({
            showSelectionPalette: true,
            preferredFormat: "hex",
            showInput: true,
            showInitial: true,
            showPaletteOnly: true, // Сделайте внешний вид только для палитры.
            palette: [// Укажите цвета, которые будут использоваться в палитре.
                ["#ffffff", "#cccccc", "#999999", "#666666", "#333333", "#000000"],
                ["#f44336", "#ff9800", "#ffeb3b", "#8bc34a", "#4caf50", "#03a9f4", "#2196f3"]
            ]
        });
        // Очистите панель.
        $("#panel_area").html('');

        // Получение и отображение информации о панели и карте, связанной с идентификатором платы.
        getPanels(detail['id']);

    }).fail(function(data) {
        msgTimeout();
    });
}

function exePost(mode, action, id, title, contents, label, etc1) {
    return $.ajax({
        type: "POST",
        url: "pdo.php",
        dataType: 'text',
        timeout:10000,
        data: {
            mode: mode,
            action: action,
            id: id,
            label: label,
            title: title,
            contents: contents,
            etc1: etc1
        }
    })
}

function nl2br(str) {
    if(!str){
    }else{
        str = str.replace(/\r\n/g, "<br />");
        str = str.replace(/(\n|\r)/g, "<br />");
    }
    return str;
}

// Получите список досок.
function getBoardList() {
    $("#board_all_list").html('');
    exePost("boards", "list", "", "", "").done(function(data) {
        var obj = $.parseJSON(data);
        var lists = '<ul>';
        $.each(obj, function(index, value) {
            lists += "<li class='list-group-item' data-board='" + value["id"] + "' style='background: 10px "+value['board_color']+"'>" + value["title"] + "</li>";
        });
        lists += '</ul>';
        $("#board_all_list").html(lists);
    }).fail(function(data) {
        msgTimeout();
    });
}


// Получите список панелей и отразите его на экране.
function getPanels(id) {

    // Отражает название и ID соответствующей панели из ID платы.
    exePost("panels", "list", id, "", "").done(function (data) {
        if (data !== false) {
            var obj = $.parseJSON(data);
            var panels = "";

            $.each(obj, function (index, value) {
                $("#panel_area").append($("#hidden .panel").html());
                $("#panel_area .panel:last-child h2").html(value["title"]);
                $("#panel_area .panel:last-child h2").attr("data-id", value["id"]);

                // Получение и отражение реквизитов карты.
                exePost("cards", "list", value["id"], "", "").done(function (card_data) {
                    var card_obj = $.parseJSON(card_data);
                    var cards = "";
                    $.each(card_obj, function (index, val) {
                        cards += "<div class='card panel panel-default' style='border-top: 12px solid " + val["label_color"] + "' label_color='" + val["label_color"] + "' cardId='" + val["id"] + "'>" + val["title"] + "</div>";
                    });
                    $("#panel_area .panel h2[data-id='" + value["id"] + "']").parent().parent().children('.panel-body').append(cards);
                    // Карточки в панели перенастроены так, чтобы их можно было перетаскивать.
                    $("#panel_area .panel h2[data-id='" + value["id"] + "']").parent().parent().children('.panel-body').sortable({
                        connectWith: '.panel-body'
                    });

                    // Если в названии карточки есть расширение изображения, оно форматируется в тег изображения.
                    $('.card.panel.panel-default').each(function () {
                        var titleString = $(this).text();
                        var fileType = titleString.split(".").pop();
                        var arr = ["jpg", "jpeg", "gif", "png"];
                        if (arr.indexOf(fileType) >= 0) {
                            $(this).wrapInner("<img src='" + titleString + "' style='width: 170px;'>");
                        }
                    });
                });
            });
        }
    }).fail(function (data) {
        msgTimeout();
    });
}

/*
 * Удалите ведущие и последующие пробелы (как однобайтовые, так и двухбайтовые).
*/
function trim(str){
    var result = str.replace(/(^\s+)|(\s+$)/g, "");
    return result.replace(/(^\s )+|(\s+$)/g, "");
}